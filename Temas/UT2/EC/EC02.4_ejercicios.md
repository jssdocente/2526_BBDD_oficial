# 📚 EC02.4 Ejercicios Agregaciones

La agregación es un concepto avanzado en el modelado de datos que nos permite representar relaciones entre entidades de una manera más intuitiva y manejable, especialmente cuando esas relaciones involucran a otras relaciones.

A veces, una relación entre dos o más entidades se convierte en un "evento" o un "concepto" tan importante por sí mismo, que necesitamos que otras entidades se relacionen _con ese evento en su totalidad_. Intentar modelar esto con relaciones de grado superior (ternarias, cuaternarias) a menudo resulta ambiguo y confuso.

La agregación es la solución elegante. Nos permite "encapsular" o "empaquetar" una relación y sus entidades participantes en una caja conceptual, tratándola como si fuera una única entidad de nivel superior.

**La Regla de Oro de la Agregación:** Se usa cuando necesitamos modelar una relación que conecta una entidad con _otra relación_.

---

### **Ejercicio 1: El Patrocinio Deportivo (Nivel Fácil)**

Este es el ejemplo clásico para entender la necesidad de la agregación.

- **Enunciado:**
  En una base de datos de una liga deportiva, se gestionan **JUGADORES**, **EQUIPOS** y **PATROCINADORES**.

  1.  Cada jugador tiene un ID y un nombre. Cada equipo tiene un ID y un nombre.
  2.  Un jugador pertenece a un único equipo en un momento dado, y un equipo tiene muchos jugadores.
  3.  Una empresa patrocinadora (de la que se conoce su CIF y nombre) quiere firmar contratos de patrocinio. El contrato no es con el jugador a secas, ni con el equipo a secas. El patrocinio es para un **jugador concreto mientras forma parte de un equipo específico**. Por ejemplo, "Nike patrocina a Cristiano Ronaldo en el Al-Nassr". De este patrocinio se guarda la fecha de inicio y la cuantía económica.

- **Pistas para el alumno:**
  - Primero, modela la relación entre `JUGADOR` y `EQUIPO`.
  - Ahora, piensa: ¿con qué se relaciona el `PATROCINADOR`? ¿Con `JUGADOR`? ¿Con `EQUIPO`? ¿O con el "fichaje" que une a ambos?
  - Dibuja una caja alrededor de la relación "pertenece a" y las entidades que une. Esa caja es tu nueva "super-entidad" con la que se relacionará `PATROCINADOR`.

---

### **Ejercicio 2: Supervisión de Proyectos (Nivel Intermedio)**

Aquí, la relación que agregamos es un poco más compleja (N:M), lo que hace que el "evento" sea más evidente.

- **Enunciado:**
  Una consultora de ingeniería gestiona los proyectos en los que trabajan sus empleados.

  1.  Se tiene información de los **EMPLEADOS** (ID, nombre, cargo) y de los **PROYECTOS** (código, descripción).
  2.  Un empleado puede trabajar en varios proyectos, y un proyecto tiene varios empleados asignados. Al asignar un empleado a un proyecto, se registra el número de horas semanales que le dedica.
  3.  Para garantizar la calidad, la empresa contrata a **AUDITORES EXTERNOS** (identificados por su NIF y nombre).
  4.  Un auditor no supervisa a un empleado en general, ni un proyecto en su totalidad. Su trabajo consiste en auditar **la labor específica que un empleado realiza para un proyecto concreto**. De esta auditoría se guarda una fecha y un veredicto ('Aprobado', 'Rechazado').

---

### **Ejercicio 3: Certificación de Calidad con Jerarquía (Nivel Intermedio-Alto)**

Este ejercicio combina lo que hemos aprendido sobre jerarquías con el nuevo concepto de agregación.

- **Enunciado:**
  Una empresa de fabricación quiere controlar la calidad de las piezas que recibe de sus proveedores para sus distintas líneas de montaje.

  1.  La empresa trabaja con **PROVEEDORES** (CIF, razón social) y gestiona un inventario de **PIEZAS** (código, nombre). Un proveedor puede suministrar muchas piezas y una pieza puede ser suministrada por varios proveedores. De cada suministro se conoce el precio unitario al que ese proveedor vende esa pieza.
  2.  El personal de la empresa se registra en la entidad **EMPLEADO** (ID, nombre). Todo empleado es o **INGENIERO** o **INSPECTOR DE CALIDAD** (son roles exclusivos). De los ingenieros se guarda su especialidad y de los inspectores, su nivel de certificación (Junior, Senior).
  3.  Un inspector de calidad debe emitir un **CERTIFICADO** para el suministro de una pieza por parte de un proveedor específico. El certificado, que tiene un código y una fecha de emisión, valida que el precio y la calidad de esa pieza, para ese proveedor, son correctos.

---

### **Ejercicio 4: Ensayos Clínicos (Nivel Avanzado)**

Este escenario es complejo y muestra perfectamente por qué una relación cuaternaria sería ambigua y cómo la agregación lo resuelve.

- **Enunciado:**
  Una organización farmacéutica gestiona ensayos clínicos para nuevos medicamentos.

  1.  Se dispone de una base de datos de **PACIENTES** (ID, nombre), **MEDICAMENTOS** en fase de prueba (código, principio activo) y **HOSPITALES** colaboradores (código, ciudad).
  2.  Un ensayo consiste en administrar un `MEDICAMENTO` específico a un `PACIENTE` en un `HOSPITAL` concreto. Esta "participación" en el ensayo se registra con una fecha de inicio y una dosis.
  3.  Cada una de estas participaciones debe ser supervisada por un único **MÉDICO INVESTIGADOR** (colegiado, nombre, especialidad). El médico no supervisa al paciente en general, ni al medicamento, ni al hospital. Supervisa el **proceso completo de administración del tratamiento al paciente en ese centro**.
  4.  Fruto de esta supervisión, el médico emite varios **INFORMES DE SEGUIMIENTO** (ID, fecha, observaciones) para cada participación que supervisa.

- **Pistas para el alumno:**
  - Aquí tenemos tres entidades (`PACIENTE`, `MEDICAMENTO`, `HOSPITAL`) que se unen en un único evento: la "participación en el ensayo". Esto podría modelarse con una relación ternaria.
  - El problema es el `MÉDICO INVESTIGADOR`. ¿Cómo se relaciona? Si lo unes a la relación ternaria, creas una relación cuaternaria muy difícil de interpretar.
  - La solución elegante es:
    1.  Modela la relación ternaria "participación" entre las tres entidades iniciales.
    2.  **Agrega** esa relación ternaria completa, creando un bloque conceptual que representa el "ensayo en curso".
    3.  Ahora, relaciona el `MÉDICO INVESTIGADOR` y los `INFORMES` con esta nueva "super-entidad" agregada.
